#!/bin/sh

set -e
set -u
set -x

echo "Building dkms modules"

. /usr/share/amnesia/build/variables

# Import ensure_hook_dependency_is_installed() and
# install_fake_package()
. /usr/local/lib/tails-shell-library/build.sh

# Install gcc-6 and fake linux-compiler-gcc-7-x86
# (linux-headers-4.14+ depends on it, but Stretch hasn't GCC 7)
# XXX:Buster: remove this hack.
ensure_hook_dependency_is_installed gcc-6
NEWEST_INSTALLED_KERNEL_VERSION="$(
    dpkg-query --showformat '${Version}\n' --show 'linux-image-*-amd64' \
    | sort --version-sort | tail -n1
)"
install_fake_package \
    linux-compiler-gcc-7-x86 \
    "${NEWEST_INSTALLED_KERNEL_VERSION}~0tails1"
ln -s /usr/bin/gcc-6 /usr/bin/gcc-7

# Any -dkms package must be installed *after* dkms to be properly registered
ensure_hook_dependency_is_installed \
    build-essential \
    dkms \
    libelf-dev

ensure_hook_dependency_is_installed \
    "linux-headers-${KERNEL_VERSION}-amd64" \
    aufs-dkms \
    virtualbox-guest-dkms

for log in $(ls /var/lib/dkms/*/*/build/make.log); do
   echo "---- $log"
   cat "$log"
done

# Ensure the modules were actually built and installed: when
# dkms.conf for a DKMS module includes a BUILD_EXCLUSIVE directive
# which does not match our kernel version, the modules won't be built
# and then we should abort the build.
for modules_dir in /lib/modules/*/kernel/fs/aufs ; do
   if [ ! -f "${modules_dir}/aufs.ko" ]; then
       echo "Can not find aufs.ko module in '${modules_dir}" >&2
       exit 1
   fi
done
for module in vboxguest vboxsf vboxvideo ; do
   for modules_dir in /lib/modules/*/updates ; do
      if [ ! -f "${modules_dir}/${module}.ko" ]; then
	  echo "Can not find ${module} module in '${modules_dir}" >&2
	  exit 1
      fi
   done
done

# virtualbox-guest-dkms's postrm script deletes any previously
# built binary module; let's delete it before the package gets purged.
rm /var/lib/dpkg/info/aufs-dkms.prerm
rm /var/lib/dpkg/info/virtualbox-guest-dkms.prerm

# Also copy the udev rules installed by virtualbox-guest-dkms to enable guest
# additions by default.
cp -a /lib/udev/rules.d/60-virtualbox-guest-dkms.rules /etc/udev/rules.d/
